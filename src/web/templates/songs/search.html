{% extends "base.html" %}

{% block title %}Search Songs{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1>üìã Songs</h1>
    <div class="dropdown" style="position: relative; display: inline-block;">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="viewMenuButton"
            onclick="document.getElementById('viewMenu').classList.toggle('show')">
            <i class="fas fa-table me-2"></i>View: {{ active_view|title }}
        </button>
        <div id="viewMenu" class="dropdown-menu"
            style="display: none; position: absolute; right: 0; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; z-index: 1000; min-width: 150px; margin-top: 5px;">
            {% for view in available_views %}
            <a class="dropdown-item" href="{{ url_for('songs.set_view', view_name=view) }}"
                style="display: block; padding: 8px 16px; color: var(--text-primary); text-decoration: none; {{ 'background: rgba(99, 102, 241, 0.1);' if view == active_view else '' }}">
                {{ view|title }}
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Close dropdown when clicking outside
    window.onclick = function (event) {
        if (!event.target.matches('.dropdown-toggle') && !event.target.matches('.dropdown-toggle *')) {
            var dropdowns = document.getElementsByClassName("dropdown-menu");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                    openDropdown.style.display = 'none';
                }
            }
        }
    }

    // Toggle helper (inline onclick handles toggle class, this handles display logic)
    document.getElementById('viewMenuButton')?.addEventListener('click', function () {
        var menu = document.getElementById('viewMenu');
        menu.style.display = menu.classList.contains('show') ? 'block' : 'none';
    });
</script>

<!-- Search Form -->
<div class="search-panel">
    <form action="{{ url_for('songs.search') }}" method="get" class="search-form" id="searchForm">
        <div id="criteria-container">
            {# Initial Row for JS cloning (hidden template) #}
            <div class="search-row template" style="display: none;">
                <select name="field" class="form-control" disabled>
                    {% for val, label in search_fields %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <select name="match" class="form-control" disabled>
                    <option value="contains">contains</option>
                    <option value="equals">equals</option>
                    <option value="starts_with">starts with</option>
                    <option value="is_empty">is empty</option>
                </select>
                <input type="text" name="value" placeholder="Search..." class="form-control search-input" disabled>
                <button type="button" class="btn btn-danger btn-sm remove-row" onclick="removeRow(this)">√ó</button>
            </div>

            {# Active Rows (loop or default) #}
            {% set criteria_count = 0 %}
            {# We need to inspect request.args logic or pass criteria_list from backend #}
            {# But for now, let's use the field/value/match vars if passed, assuming they might be lists or single #}

            {# If 'field' is a string, it's single mode. If list, multi mode.
            However, Jinja context usually has processed vars.
            Let's assume the route passes scalar 'field', 'value', 'match' for single mode,
            OR we check request.args directly. #}

            {% set fields = request.args.getlist('field') %}
            {% set values = request.args.getlist('value') %}
            {% set matches = request.args.getlist('match') %}

            {% if not fields %}
            {# Default / First Load #}
            {% set fields = [field] if field else ['artist'] %}
            {% set values = [value] if value else [''] %}
            {% set matches = [match] if match else ['contains'] %}
            {% endif %}

            {% for i in range(fields|length) %}
            <div class="search-row">
                <select name="field" class="form-control">
                    {% for val, label in search_fields %}
                    <option value="{{ val }}" {{ 'selected' if val==fields[i] else '' }}>{{ label }}</option>
                    {% endfor %}
                </select>
                <select name="match" class="form-control">
                    <option value="contains" {{ 'selected' if matches[i]=='contains' else '' }}>contains</option>
                    <option value="equals" {{ 'selected' if matches[i]=='equals' else '' }}>equals</option>
                    <option value="starts_with" {{ 'selected' if matches[i]=='starts_with' else '' }}>starts with
                    </option>
                    <option value="is_empty" {{ 'selected' if matches[i]=='is_empty' else '' }}>is empty</option>
                </select>
                <input type="text" name="value" value="{{ values[i] }}" placeholder="Search..."
                    class="form-control search-input">

                {% if loop.index0 == 0 %}
                <button type="submit" class="btn btn-primary">üîç Search</button>
                {% else %}
                <button type="button" class="btn btn-danger btn-sm remove-row" onclick="removeRow(this)">√ó</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="search-actions" style="margin-top: 10px;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="addCriteria()">+ Add Filter</button>
        </div>
    </form>
</div>

<script>
    function addCriteria() {
        const template = document.querySelector('.search-row.template');
        const container = document.getElementById('criteria-container');
        const newRow = template.cloneNode(true);

        newRow.classList.remove('template');
        newRow.style.display = 'flex';

        // Enable inputs
        const inputs = newRow.querySelectorAll('input, select');
        inputs.forEach(input => input.disabled = false);

        container.appendChild(newRow);
    }

    function removeRow(btn) {
        btn.closest('.search-row').remove();
    }
</script>

<!-- Results -->
{% if results is not none %}
<div class="results-panel">
    <div class="results-header">
        <span class="results-count">Found {{ results.count }} results</span>
    </div>

    {% if results.count > 0 %}
    <table class="data-table">
        <thead>
            <tr>
                <th class="col-check"><input type="checkbox" id="select-all"></th>
                {% for col in grid_columns %}
                <th>{{ col.label }}</th>
                {% endfor %}
                <th class="col-actions"></th>
            </tr>
        </thead>
        <tbody>
            {% for record in results %}
            <tr class="{{ 'active' if loop.index0 == position else '' }}">
                <td class="col-check"><input type="checkbox" value="{{ record.primary_key }}" class="song-check"></td>

                {% for col in grid_columns %}
                <td>
                    {% if col.name == pk_field %}
                    <span class="mono">{{ record[col.name] }}</span>
                    {% elif col.name.startswith('fldCat1') %}
                    {# Resolve Genre ID to Name #}
                    {% set val = record[col.name] %}
                    {{ genre_map.get(val, val) if val else '' }}
                    {% else %}
                    {{ record[col.name] or '' }}
                    {% endif %}
                </td>
                {% endfor %}

                <td class="col-actions">
                    <a href="{{ url_for('songs.view', song_id=record.primary_key) }}"
                        class="btn btn-sm btn-secondary">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination would go here -->
    {% if results.count > 50 %}
    <div class="results-footer">
        <span class="text-muted">Showing first 50 of {{ results.count }} results</span>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <p>No songs found matching your search.</p>
    </div>
    {% endif %}
</div>

<!-- Floating Bulk Action Bar -->
<div id="bulk-bar" class="bulk-bar" style="display: none;">
    <div class="bulk-content">
        <span class="selection-count"><span id="selected-count">0</span> songs selected</span>
        <div class="bulk-actions">
            <button class="btn btn-accent" id="btn-bulk-edit">üîß Bulk Edit</button>
            <button class="btn btn-secondary" id="btn-bulk-export">üì¶ Export Selected</button>
            <button class="btn btn-danger" id="btn-bulk-hide">üö´ Disable Selected</button>
            <button class="btn btn-link" id="btn-clear-selection">Clear</button>
        </div>
    </div>
</div>

{% else %}
<div class="empty-state">
    <p>Enter a search term above to find songs.</p>
</div>
{% endif %}

<style>
    .col-check {
        width: 40px;
        text-align: center;
    }

    .col-check input {
        cursor: pointer;
        scale: 1.2;
    }

    .bulk-bar {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-secondary);
        border: 1px solid var(--accent-primary);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(99, 102, 241, 0.2);
        padding: 15px 30px;
        border-radius: 50px;
        z-index: 1000;
        display: none;
        animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes slideUp {
        from {
            transform: translate(-50%, 100px);
            opacity: 0;
        }

        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }

    .bulk-content {
        display: flex;
        align-items: center;
        gap: 40px;
    }

    .selection-count {
        font-weight: 700;
        color: var(--accent-primary);
        font-size: 1.1rem;
    }

    .bulk-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .btn-accent {
        background: var(--accent-primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-link {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        text-decoration: underline;
    }

    .row-selected {
        background: rgba(99, 102, 241, 0.1) !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selectAll = document.getElementById('select-all');
        const songChecks = document.querySelectorAll('.song-check');
        const bulkBar = document.getElementById('bulk-bar');
        const selectedCount = document.getElementById('selected-count');
        const btnClear = document.getElementById('btn-clear-selection');

        function updateBulkBar() {
            const checked = document.querySelectorAll('.song-check:checked');
            const count = checked.length;

            selectedCount.textContent = count;
            bulkBar.style.display = count > 0 ? 'flex' : 'none';

            // Highlight rows
            songChecks.forEach(cb => {
                cb.closest('tr').classList.toggle('row-selected', cb.checked);
            });
        }

        if (selectAll) {
            selectAll.addEventListener('change', () => {
                songChecks.forEach(cb => cb.checked = selectAll.checked);
                updateBulkBar();
            });
        }

        songChecks.forEach(cb => {
            cb.addEventListener('change', () => {
                if (!cb.checked && selectAll) selectAll.checked = false;
                updateBulkBar();
            });
        });

        if (btnClear) {
            btnClear.addEventListener('click', () => {
                songChecks.forEach(cb => cb.checked = false);
                if (selectAll) selectAll.checked = false;
                updateBulkBar();
            });
        }

        // Handle Bulk Edit click
        const btnBulkEdit = document.getElementById('btn-bulk-edit');
        if (btnBulkEdit) {
            btnBulkEdit.addEventListener('click', () => {
                const ids = Array.from(document.querySelectorAll('.song-check:checked')).map(cb => cb.value);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('songs.bulk_edit') }}";

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'ids';
                input.value = ids.join(',');
                form.appendChild(input);

                document.body.appendChild(form);
                form.submit();
            });
        }

        // Handle Bulk Export
        const btnBulkExport = document.getElementById('btn-bulk-export');
        if (btnBulkExport) {
            btnBulkExport.addEventListener('click', () => {
                const ids = Array.from(document.querySelectorAll('.song-check:checked')).map(cb => cb.value);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('export.download') }}";

                // Add hidden fields for export config
                const fields = {
                    'ids': ids.join(','),
                    'type': 'selected_songs',
                    'format': 'csv',
                    'resolve_lookups': 'on'
                };

                for (const [name, value] of Object.entries(fields)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    form.appendChild(input);
                }

                document.body.appendChild(form);
                form.submit();
            });
        }

        // Handle Bulk Disable
        const btnBulkHide = document.getElementById('btn-bulk-hide');
        if (btnBulkHide) {
            btnBulkHide.addEventListener('click', () => {
                const count = document.querySelectorAll('.song-check:checked').length;
                if (!confirm(`Are you sure you want to DISABLE ${count} songs? They will no longer be played by Jazler.`)) {
                    return;
                }

                const ids = Array.from(document.querySelectorAll('.song-check:checked')).map(cb => cb.value);
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('songs.bulk_disable') }}";

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'ids';
                input.value = ids.join(',');
                form.appendChild(input);

                document.body.appendChild(form);
                form.submit();
            });
        }
    });
</script>
{% endblock %}