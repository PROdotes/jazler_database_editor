{% extends "base.html" %}

{% block title %}Edit Song #{{ song.primary_key }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-nav">
        <a href="{{ url_for('songs.search') }}" class="btn btn-secondary">‚óÄ Back to Search</a>
    </div>
    <div class="header-title-row">
        <h1>Edit Song #{{ song.primary_key }}</h1>

        {% if nav and nav.total > 0 %}
        <div class="batch-nav">
            {% if nav.prev_id %}
            <a href="{{ url_for('songs.edit', song_id=nav.prev_id) }}" class="btn btn-nav"
                title="Previous song ({{ nav.prev_id }})">‚óÄ Prev</a>
            {% else %}
            <span class="btn btn-nav disabled">‚óÄ Prev</span>
            {% endif %}

            <span class="batch-position">{{ nav.position }} of {{ nav.total }}</span>

            {% if nav.next_id %}
            <a href="{{ url_for('songs.edit', song_id=nav.next_id) }}" class="btn btn-nav"
                title="Next song ({{ nav.next_id }})">Next ‚ñ∂</a>
            {% else %}
            <span class="btn btn-nav disabled">Next ‚ñ∂</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<form action="{{ url_for('songs.save', song_id=song.primary_key) }}" method="post" class="edit-form">
    <div class="compare-container">
        <div class="compare-grid">
            <!-- Headers -->
            <div class="compare-header">
                <div class="header-item"></div>
                <div class="header-item">üìÅ Database</div>
                <div class="header-item"></div>
                <div class="header-item id3">üè∑Ô∏è ID3 Tags</div>
            </div>

            <!-- Artist -->
            {% set id3_artist = id3_data.get('artist', '') if id3_data else '' %}
            {% set artist_match = (id3_data and id3_artist == song.artist) %}
            <div class="compare-row {{ 'match' if artist_match else 'mismatch' }}">
                <div class="field-label">Artist</div>
                <div class="field-db">
                    {% from "macros/entity_picker.html" import entity_picker %}
                    {{ entity_picker(
                    'fldArtistCode',
                    {'id': song.fldArtistCode, 'name': song.artist},
                    '',
                    '/artists/search'
                    ) }}
                    <input type="hidden" name="fldArtistName" value="{{ song.artist }}">
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3-artist', 'fldArtistCode_display')"><i
                            class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Matches' if artist_match else 'Mismatched' }}">
                        <i class="fas {{ 'fa-check' if artist_match else 'fa-sync-alt' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncField('fldArtistCode_display', 'id3-artist')"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-artist" name="id3_artist"
                        value="{{ id3_data.get('artist', '') if id3_data else '' }}" placeholder="‚Äî"
                        class="form-control id3-input">
                </div>
            </div>

            <!-- Title -->
            {% set id3_title = id3_data.get('title', '') if id3_data else '' %}
            {% set title_match = (id3_data and id3_title == song.title) %}
            <div class="compare-row {{ 'match' if title_match else 'mismatch' }}">
                <div class="field-label">Title</div>
                <div class="field-db">
                    <input type="text" id="title" name="title" value="{{ song.title or '' }}" class="form-control">
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3-title', 'title')"><i class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Matches' if title_match else 'Mismatched' }}">
                        <i class="fas {{ 'fa-check' if title_match else 'fa-sync-alt' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncField('title', 'id3-title')"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-title" name="id3_title"
                        value="{{ id3_data.get('title', '') if id3_data else '' }}" placeholder="‚Äî"
                        class="form-control id3-input">
                </div>
            </div>

            <!-- Album -->
            {% set id3_album = id3_data.get('album', '') if id3_data else '' %}
            {% set album_match = (id3_data and id3_album == song.album) %}
            <div class="compare-row {{ 'match' if album_match else 'mismatch' }}">
                <div class="field-label">Album</div>
                <div class="field-db">
                    <input type="text" id="album" name="album" value="{{ song.album or '' }}" class="form-control">
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3-album', 'album')"><i class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Matches' if album_match else 'Mismatched' }}">
                        <i class="fas {{ 'fa-check' if album_match else 'fa-sync-alt' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncField('album', 'id3-album')"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-album" name="id3_album"
                        value="{{ id3_data.get('album', '') if id3_data else '' }}" placeholder="‚Äî"
                        class="form-control id3-input">
                </div>
            </div>

            <!-- Year / Decade -->
            {% set id3_year = id3_data.get('year', '') if id3_data else '' %}
            {% set year_match = (id3_data and id3_year|string == song.year|string) %}
            <div class="compare-row {{ 'match' if year_match else 'mismatch' }}">
                <div class="field-label">Year / Decade</div>
                <div class="field-db" title="Year and Decade are linked">
                    <div class="field-row">
                        <input type="number" id="year" name="year" value="{{ song.year or '' }}" class="form-control"
                            min="1900" max="2099" style="flex: 1;">
                        <select id="decade" name="decade" class="form-control" style="flex: 1.5;">
                            <option value="">(Decade)</option>
                            {% for id, name in decade_map|dictsort(false, 'value') %}
                            {% if id|int != 0 and name %}
                            <option value="{{ id }}" {% if song.decade==id %}selected{% endif %}>{{ name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3-year', 'year')"><i class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Matches' if year_match else 'Mismatched' }}">
                        <i class="fas {{ 'fa-check' if year_match else 'fa-sync-alt' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncField('year', 'id3-year')"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-year" name="id3_year"
                        value="{{ id3_data.get('year', '') if id3_data else '' }}" placeholder="‚Äî"
                        class="form-control id3-input">
                </div>
            </div>

            <!-- Composer -->
            {% set composer_match = (id3_data and id3_data.get('composer') == song.composer) %}
            <div class="compare-row {{ 'match' if composer_match else 'mismatch' }}">
                <div class="field-label">Composer</div>
                <div class="field-db" title="Composer is primarily for internal database">
                    <input type="text" id="composer" name="composer" value="{{ song.composer or '' }}"
                        class="form-control">
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3-composer', 'composer')"><i class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Matches' if composer_match else 'Mismatched' }}">
                        <i class="fas {{ 'fa-check' if composer_match else 'fa-sync-alt' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncField('composer', 'id3-composer')"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-composer" name="id3_composer"
                        value="{{ id3_data.composer if id3_data else '' }}" placeholder="‚Äî"
                        class="form-control id3-input">
                </div>
            </div>

            <!-- Publisher -->
            {% set publisher_match = (id3_data and id3_data.get('publisher') == song.publisher) %}
            <div class="compare-row {{ 'match' if publisher_match else 'mismatch' }}">
                <div class="field-label">Publisher</div>
                <div class="field-db" title="Publisher/Label">
                    <input type="text" id="publisher" name="publisher" value="{{ song.publisher or '' }}"
                        class="form-control">
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3-publisher', 'publisher')"><i class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Matches' if publisher_match else 'Mismatched' }}">
                        <i class="fas {{ 'fa-check' if publisher_match else 'fa-sync-alt' }}" id="icon-publisher"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncField('publisher', 'id3-publisher')"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-publisher" name="id3_publisher"
                        value="{{ id3_data.publisher if id3_data else '' }}" placeholder="‚Äî"
                        class="form-control id3-input">
                </div>
            </div>

            <!-- ISRC -->
            {% set isrc_match = (id3_data and id3_data.get('isrc') == song.isrc) %}
            <div class="compare-row {{ 'match' if isrc_match else 'mismatch' }}">
                <div class="field-label">ISRC</div>
                <div class="field-db">
                    <input type="text" id="isrc" name="isrc" value="{{ song.isrc or '' }}" class="form-control mono"
                        placeholder="XX-XXX-YY-NNNNN">
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3-isrc', 'isrc')"><i class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Matches' if isrc_match else 'Mismatched' }}">
                        <i class="fas {{ 'fa-check' if isrc_match else 'fa-sync-alt' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncField('isrc', 'id3-isrc')"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-isrc" name="id3_isrc" value="{{ id3_data.isrc if id3_data else '' }}"
                        placeholder="‚Äî" class="form-control id3-input mono">
                </div>
            </div>

            <!-- Genres -->
            {% set db_genre_name = genre_map.get(song.genre|int, '') %}
            {% set id3_genre_val = id3_data.get('genre', '') if id3_data else '' %}
            {% set genre_match = (id3_genre_val == db_genre_name) %}
            <div class="compare-row {{ 'match' if genre_match else 'mismatch' }}">
                <div class="field-label">Genres</div>
                <div class="field-db">
                    <div class="field-row">
                        <select id="genre" name="genre" class="form-control" title="Primary Genre (Cat1a)">
                            {% for id, name in genre_map|dictsort(false, 'value') %}
                            {% if name %}<option value="{{ id }}" {% if song.genre==id %}selected{% endif %}>{{ name }}
                            </option>{% endif %}
                            {% endfor %}
                        </select>
                        <select id="subcat1" name="subcat1" class="form-control" title="Secondary Genre (Cat1b)">
                            <option value="">(None)</option>
                            {% for id, name in genre_map|dictsort(false, 'value') %}
                            {% if name %}<option value="{{ id }}" {% if song['fldCat1b']==id %}selected{% endif %}>{{
                                name }}</option>{% endif %}
                            {% endfor %}
                        </select>
                        <select id="subcat2" name="subcat2" class="form-control" title="Tertiary Genre (Cat1c)">
                            <option value="">(None)</option>
                            {% for id, name in genre_map|dictsort(false, 'value') %}
                            {% if name %}<option value="{{ id }}" {% if song['fldCat1c']==id %}selected{% endif %}>{{
                                name }}</option>{% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="diff-bridge">
                    <div class="bridge-icon" title="{{ 'Matches Tag' if genre_match else 'Mismatched Tag' }}">
                        <i class="fas {{ 'fa-check' if genre_match else 'fa-sync-alt' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3" onclick="syncGenre()"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3-genre" name="id3_genre"
                        value="{{ id3_data.get('genre', '') if id3_data else '' }}" placeholder="‚Äî"
                        class="form-control id3-input">
                </div>
            </div>

            <!-- Tempo & Status -->
            <div class="compare-row only-db">
                <div class="field-label">Tempo & Status</div>
                <div class="field-db" style="display: flex; align-items: center; gap: 20px;">
                    <select name="tempo" class="form-control" style="width: 140px;">
                        <option value="">(Tempo)</option>
                        {% for id, name in tempo_map.items() %}<option value="{{ id }}" {% if song.tempo==id
                            %}selected{% endif %}>{{ name }}</option>{% endfor %}
                    </select>

                    <div class="checkbox-field" style="border: none; padding: 0; margin: 0; display: flex; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label class="toggle-switch">
                                <input type="checkbox" name="enabled" {{ 'checked' if song.enabled else '' }}>
                                <span class="slider round"></span>
                            </label>
                            <span class="checkbox-label">Enabled</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label class="toggle-switch">
                                <input type="checkbox" name="enabled_auto" {{ 'checked' if song['fldEnabledAuto']
                                    else '' }}>
                                <span class="slider round"></span>
                            </label>
                            <span class="checkbox-label">Auto</span>
                        </div>
                    </div>
                </div>
                <div class="diff-bridge">
                    <div class="bridge-icon"></div>
                </div>
                <div class="field-id3"></div>
            </div>

            <!-- Duration -->
            {% set db_dur = (song.duration|float)|round(2) %}
            {% set id3_dur = (id3_data.get('duration', 0)|float) if id3_data else 0 %}
            {% set dur_match = (db_dur == id3_dur) %}
            <div class="compare-row {{ 'match' if dur_match else 'mismatch' }}">
                <div class="field-label">Duration</div>
                <div class="field-db" id="db-duration-val" data-value="{{ display_data.duration_raw }}">
                    <input type="text" id="duration" name="duration" value="{{ display_data.duration_raw }}"
                        class="form-control mono">
                </div>
                <div class="diff-bridge">
                    <button type="button" class="sync-btn pull" title="Pull from ID3"
                        onclick="syncField('id3_duration', 'duration')"><i class="fas fa-chevron-left"></i></button>
                    <div class="bridge-icon" title="{{ 'Durs Match' if dur_match else 'Drift Detected' }}">
                        <i class="fas {{ 'fa-check' if dur_match else 'fa-clock' }}"></i>
                    </div>
                    <button type="button" class="sync-btn push" title="Push to ID3"
                        onclick="syncDuration('duration', 'id3_duration')"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="field-id3">
                    <input type="text" id="id3_duration" name="id3_duration" value="{{ id3_dur }}"
                        class="form-control id3-input mono">
                </div>
            </div>
        </div>
    </div>

    <!-- File Info -->
    <div class="file-info-bar">
        <div class="file-path">
            <label>Path:</label>
            <span class="mono">{{ file_info.db_path or 'No path' }}</span>

            {% if file_info.vfs_status == 'live' %}
            <span class="status-badge ok">‚úì Live</span>
            {% elif file_info.vfs_status == 'virtual' %}
            <span class="status-badge virtual">‚ö° Virtual</span>
            {% else %}
            <span class="status-badge error">‚úó Missing</span>
            {% endif %}

            {% if file_info.db_path != file_info.resolved_path %}
            <div class="resolved-path">
                <label>Mapped:</label>
                <span class="mono">{{ file_info.resolved_path }}</span>
            </div>
            {% endif %}
        </div>

        <div class="file-meta">
            <!-- Extended metadata that isn't editable yet -->
            <span>Duration: {{ song.duration or '0' }}s</span>
            <span>BPM: {{ song.bpm or '‚Äî' }}</span>
        </div>
    </div>

    <!-- Tools Panel -->
    <div class="tools-panel">
        <div class="tools-header">
            <h3>üîß Quick Tools</h3>
        </div>
        <div class="tools-buttons">
            <button type="button" class="btn btn-tool" onclick="parseAlbumField()"
                title="Split 'Album; Publisher; Year' into separate fields">
                üì¶ Parse Album
            </button>
            <button type="button" class="btn btn-tool" onclick="trimWhitespace()"
                title="Trim leading/trailing whitespace from all fields">
                ‚úÇÔ∏è Trim Whitespace
            </button>
            <button type="button" class="btn btn-tool" onclick="titleCaseTitle()" title="Convert Title to Title Case">
                üî§ Title Case
            </button>
            <button type="button" class="btn btn-tool" onclick="normalizeFeat()"
                title="Normalize 'ft.', 'feat', 'featuring' to 'feat.' (Currently disabled for Artist rework)" disabled>
                üé§ Normalize feat.
            </button>
            <button type="button" class="btn btn-tool" onclick="clearComposer()" title="Clear the composer field">
                üóëÔ∏è Clear Composer
            </button>
        </div>
    </div>

    <!-- Filesystem Options -->
    <div class="tools-panel fs-options">
        <div class="tools-header">
            <h3>üìÇ Filesystem Options</h3>
        </div>
        <div class="tools-buttons">
            <label class="checkbox-container">
                <input type="checkbox" name="rename_physical" id="rename_physical">
                <span class="checkmark"></span>
                Rename physical file to match "Artist - Title"
            </label>
            <div id="rename-preview" class="rename-preview mono" style="display: none;">
                Preview: <span id="preview-text"></span>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
        <div class="action-group">
            <a href="https://www.google.com/search?q={{ (song.artist or '') | urlencode }}+{{ (song.title or '') | urlencode }}"
                target="_blank" class="btn btn-secondary">üîç Google</a>
            <a href="https://www.discogs.com/search/?q={{ (song.artist or '') | urlencode }}+{{ (song.title or '') | urlencode }}&type=all"
                target="_blank" class="btn btn-secondary">üîç Discogs</a>
            <a href="https://musicbrainz.org/taglookup/index?tag-lookup.artist={{ (song.artist or '') | urlencode }}&tag-lookup.release={{ (song.title or '') | urlencode }}"
                target="_blank" class="btn btn-secondary">üß† MusicBrainz</a>
        </div>

        <div class="action-group">
            <a href="{{ url_for('songs.view', song_id=song.primary_key) }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">üíæ Save</button>
            {% if nav and nav.next_id %}
            <button type="submit" name="next_action" value="next" class="btn btn-success">üíæ Save & Next ‚ñ∂</button>
            {% endif %}
        </div>
    </div>
</form>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/edit.js') }}"></script>
{% endblock %}
{% endblock %}